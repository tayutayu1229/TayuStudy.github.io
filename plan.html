<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¿ãƒ‡ã‚£ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

    <style>
        /* === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° === */
        :root {
            --color-bg: #f4f7f6;
            --color-surface: #ffffff;
            --color-text-primary: #2a2a2a;
            --color-text-secondary: #555;
            --color-border: #eee;
            --color-border-input: #ccc;
            --color-primary: #007bff;
            --color-primary-hover: #0056b3;
            --color-danger: #dc3545;
            --color-danger-hover: #c82333;
            --color-success: #28a745;
            --color-warning: #fd7e14;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* === ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ === */
        body[data-theme="dark"] {
            --color-bg: #121212;
            --color-surface: #1e1e1e;
            --color-text-primary: #f1f1f1;
            --color-text-secondary: #aaa;
            --color-border: #333;
            --color-border-input: #555;
        }

        /* === åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« === */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Noto Sans CJK JP', 'Yu Gothic', Meiryo, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 900px; /* å°‘ã—å¹…ã‚’åºƒã’ã‚‹ */
            margin: 0 auto;
            background-color: var(--color-surface);
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: background-color 0.3s;
        }
        
        main {
            padding: 20px 30px 30px;
        }

        button {
            cursor: pointer;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s, opacity 0.2s;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-danger:hover { background-color: var(--color-danger-hover); }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }

        input, select, textarea {
            background-color: var(--color-surface);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-input);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9em;
        }

        /* === ãƒšãƒ¼ã‚¸åˆ‡æ›¿ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ === */
        nav {
            background-color: var(--color-bg);
            padding: 15px 30px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        nav .nav-tabs button {
            background: none;
            border: none;
            padding: 10px 15px;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--color-text-secondary);
            border-bottom: 3px solid transparent;
        }
        nav .nav-tabs button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        /* === â˜… ãƒšãƒ¼ã‚¸æœ¬ä½“ (éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ) === */
        .page {
            display: none; /* JSã§.activeã‚’ä»˜ä¸ã—ã¦è¡¨ç¤º */
        }
        .page.active {
            display: block;
        }

        /* === 1. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãƒšãƒ¼ã‚¸ === */
        #page-planner header {
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        h1 { margin: 0; font-size: 1.8em; }
        h2 { margin: 10px 0 0; font-weight: 600; }
        #deadline-display { font-size: 1.2em; color: var(--color-danger); }
        #month-selector { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .month-tab {
            padding: 10px 20px;
            border: 1px solid var(--color-border-input);
            border-radius: 8px;
            background-color: var(--color-bg);
            font-weight: 600;
            color: var(--color-text-secondary);
        }
        .month-tab:hover { background-color: var(--color-border); }
        .month-tab.active { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }

        #progress-summary { font-size: 1.1em; font-weight: 600; margin-top: 20px; color: var(--color-primary); }
        #progress-bar-container { width: 100%; background-color: var(--color-border); border-radius: 4px; height: 10px; margin-top: 8px; overflow: hidden; }
        #progress-bar { height: 100%; width: 0%; background-color: var(--color-primary); border-radius: 4px; transition: width 0.5s ease; }

        /* === ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éƒ¨ === */
        #planner-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .control-group { display: flex; gap: 10px; align-items: center; }
        .control-group label { font-weight: 600; font-size: 0.9em; }

        /* === ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ (List View) === */
        .task-item {
            display: flex;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--color-border);
            transition: opacity 0.3s, background-color 0.3s;
        }
        .task-item:last-child { border-bottom: none; }
        .task-item[data-status="å®Œäº†"] { opacity: 0.6; }
        .task-item[data-status="å®Œäº†"] .task-details { text-decoration: line-through; color: var(--color-text-secondary); }
        .task-item[data-status="ä½œæ¥­ä¸­"] { background-color: rgba(0, 123, 255, 0.05); }
        body[data-theme="dark"] .task-item[data-status="ä½œæ¥­ä¸­"] { background-color: rgba(0, 123, 255, 0.1); }

        .task-details { flex-grow: 1; margin-right: 15px; }
        .task-subject { font-weight: 600; font-size: 1.1em; margin-bottom: 5px; }
        .task-name { font-size: 0.9em; color: var(--color-text-secondary); }

        .task-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .task-status-select, .task-priority-select {
            padding: 8px 12px; border-radius: 6px; border: 1px solid var(--color-border-input);
            background-color: var(--color-surface); color: var(--color-text-primary);
            font-size: 0.9em; cursor: pointer;
        }
        /* å„ªå…ˆåº¦ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è‰² */
        .task-priority-select[data-priority="S"] { border-color: var(--color-danger); background-color: rgba(220, 53, 69, 0.1); }
        .task-priority-select[data-priority="A"] { border-color: var(--color-warning); background-color: rgba(253, 126, 20, 0.1); }
        .task-priority-select[data-priority="B"] { border-color: var(--color-primary); background-color: rgba(0, 123, 255, 0.1); }
        .task-priority-select[data-priority="C"] { border-color: var(--color-success); background-color: rgba(40, 167, 69, 0.1); }

        /* â˜… æ–°æ©Ÿèƒ½: å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .delete-task-btn {
            background: none; border: none; font-size: 1.2em; color: var(--color-text-secondary);
            padding: 5px; opacity: 0.7;
        }
        .delete-task-btn:hover { color: var(--color-danger); opacity: 1; }

        /* === â˜… ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ (Board View) === */
        #kanban-board {
            display: flex;
            gap: 15px;
            overflow-x: auto; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            padding: 10px 0;
            min-height: 400px;
        }
        .kanban-column {
            flex: 1;
            min-width: 280px;
            background-color: var(--color-bg);
            border-radius: 8px;
            padding: 15px;
        }
        .kanban-column h3 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-border);
            color: var(--color-text-primary);
        }
        .kanban-column[data-status="æœªç€æ‰‹"] { border-top: 3px solid var(--color-danger); }
        .kanban-column[data-status="ä½œæ¥­ä¸­"] { border-top: 3px solid var(--color-primary); }
        .kanban-column[data-status="å®Œäº†"] { border-top: 3px solid var(--color-success); }
        
        .kanban-card-list { display: flex; flex-direction: column; gap: 10px; }
        .kanban-card {
            background-color: var(--color-surface);
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid var(--color-primary); /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
        }
        /* ã‚«ãƒ¼ãƒ‰ã®å·¦æ ã‚’å„ªå…ˆåº¦ã§è‰²åˆ†ã‘ */
        .kanban-card[data-priority="S"] { border-left-color: var(--color-danger); }
        .kanban-card[data-priority="A"] { border-left-color: var(--color-warning); }
        .kanban-card[data-priority="B"] { border-left-color: var(--color-primary); }
        .kanban-card[data-priority="C"] { border-left-color: var(--color-success); }
        
        .kanban-card .task-subject { font-size: 1em; }
        .kanban-card .task-name { font-size: 0.85em; }
        .kanban-card .task-controls { margin-top: 10px; flex-direction: row; }
        .kanban-card .task-status-select, .kanban-card .task-priority-select { padding: 5px 8px; width: 100%; }
        .kanban-card .delete-task-btn { position: absolute; top: 5px; right: 5px; } /* ã‚«ãƒ³ãƒãƒ³ã§ã¯å‰Šé™¤ãƒœã‚¿ãƒ³éè¡¨ç¤º (ç°¡ç•¥åŒ–ã®ãŸã‚) */

        /* === â˜… ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ãƒ•ãƒƒã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« === */
        #planner-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--color-border);
            background-color: var(--color-bg);
            display: flex;
            gap: 10px;
        }
        
        /* === 2. ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼ãƒšãƒ¼ã‚¸ === */
        #page-timer {
            text-align: center;
            padding: 40px 30px;
        }
        #timer-display {
            font-size: 6em; /* å·¨å¤§ã« */
            font-weight: 200;
            margin: 20px 0;
            color: var(--color-primary);
        }
        #timer-mode {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--color-text-secondary);
        }
        #timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        #timer-controls button {
            font-size: 1.1em;
            padding: 12px 25px;
        }

        /* === â˜… æ–°æ©Ÿèƒ½: ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« === */
        #add-task-modal {
            border: none;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 0; /* JSã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã•ã›ã‚‹ãŸã‚paddingã¯å†…å´ã§ */
            max-width: 500px;
            background-color: var(--color-surface);
            color: var(--color-text-primary);
        }
        /* backdropï¼ˆèƒŒæ™¯ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #add-task-modal::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }
        
        .modal-content { padding: 30px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        #close-modal-btn { background: none; border: none; font-size: 1.5em; color: var(--color-text-secondary); }
        
        #add-task-form { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: 600; }
        .form-group input, .form-group select { width: 100%; box-sizing: border-box; } /* paddingã‚’è€ƒæ…® */
        .modal-footer { margin-top: 25px; text-align: right; }

    </style>
</head>
<body data-theme="light"> <div class="container">

        <nav>
            <div class="nav-tabs">
                <button id="nav-planner" class="nav-tab active" data-page="planner">ğŸ“– ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</button>
                <button id="nav-timer" class="nav-tab" data-page="timer">â±ï¸ ã‚¿ã‚¤ãƒãƒ¼</button>
            </div>
            <div class="nav-controls">
                <button id="dark-mode-toggle" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">â˜€ï¸</button>
            </div>
        </nav>

        <main id="page-planner" class="page active">
            <header>
                <h1 id="main-title">ãƒ¬ãƒãƒ¼ãƒˆé€²æ—ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
                <h2 id="deadline-display">ç· ã‚åˆ‡ã‚Š: --/--</h2>
                
                <div id="month-selector">
                    <button class="month-tab" data-month="11">11æœˆ</button>
                    <button class="month-tab" data-month="12">12æœˆ</button>
                    <button class="month-tab" data-month="1">1æœˆ</button>
                    <button class="month-tab" data-month="2">2æœˆ</button>
                    <button class="month-tab" data-month="3">3æœˆ</button>
                </div>
                
                <div id="progress-summary">é€²æ—: 0 / 0 å®Œäº†</div>
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
            </header>

            <div id="planner-controls">
                <div class="control-group">
                    <label for="view-mode-toggle">è¡¨ç¤º:</label>
                    <select id="view-mode-toggle">
                        <option value="list">ãƒªã‚¹ãƒˆè¡¨ç¤º</option>
                        <option value="board">ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰è¡¨ç¤º</option>
                    </select>
                </div>
                <button id="add-task-btn" class="btn-primary">ï¼‹ ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
            </div>

            <section id="task-display-area">
                <div id="task-list"></div>
                <div id="kanban-board" style="display: none;">
                    <div class="kanban-column" data-status="æœªç€æ‰‹">
                        <h3>æœªç€æ‰‹</h3>
                        <div class="kanban-card-list" id="kanban-col-todo"></div>
                    </div>
                    <div class="kanban-column" data-status="ä½œæ¥­ä¸­">
                        <h3>ä½œæ¥­ä¸­</h3>
                        <div class="kanban-card-list" id="kanban-col-doing"></div>
                    </div>
                    <div class="kanban-column" data-status="å®Œäº†">
                        <h3>å®Œäº†</h3>
                        <div class="kanban-card-list" id="kanban-col-done"></div>
                    </div>
                </div>
            </section>
            
            <footer id="planner-footer">
                <button id="reset-button" class="btn-danger">ã“ã®æœˆã®é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                <button id="export-data-btn" class="btn-secondary">å…¨ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã— (Export JSON)</button>
            </footer>
        </main>

        <main id="page-timer" class="page">
            <h2 id="timer-mode">å‹‰å¼· (25åˆ†)</h2>
            <div id="timer-display">25:00</div>
            <div id="timer-controls">
                <button id="timer-start-pause" class="btn-primary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                <button id="timer-reset" class="btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </main>

    </div> <dialog id="add-task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h2>
                <button id="close-modal-btn">âœ•</button>
            </div>
            <form id="add-task-form">
                <div class="form-group">
                    <label for="task-subject">ç§‘ç›®</label>
                    <input type="text" id="task-subject" required>
                </div>
                <div class="form-group">
                    <label for="task-name">ã‚¿ã‚¹ã‚¯å†…å®¹</label>
                    <input type="text" id="task-name" required>
                </div>
                <div class="form-group">
                    <label for="task-priority">å„ªå…ˆåº¦</label>
                    <select id="task-priority">
                        <option value="S">S (æœ€é«˜)</option>
                        <option value="A">A (é«˜ã„)</option>
                        <option value="B" selected>B (æ™®é€š)</option>
                        <option value="C">C (ä½ã„)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-primary">è¿½åŠ ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </dialog>

    <template id="task-template-list">
        <div class="task-item" data-status="æœªç€æ‰‹">
            <div class="task-details">
                <div class="task-subject">ç§‘ç›®å</div>
                <div class="task-name">ã‚¿ã‚¹ã‚¯è©³ç´°</div>
            </div>
            <div class="task-controls">
                <select class="task-priority-select" title="å„ªå…ˆåº¦">
                    <option value="S">å„ªå…ˆåº¦: S (æœ€é«˜)</option>
                    <option value="A">å„ªå…ˆåº¦: A (é«˜ã„)</option>
                    <option value="B">å„ªå…ˆåº¦: B (æ™®é€š)</option>
                    <option value="C">å„ªå…ˆåº¦: C (ä½ã„)</option>
                </select>
                <select class="task-status-select" title="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">
                    <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
                    <option value="ä½œæ¥­ä¸­">ä½œæ¥­ä¸­</option>
                    <option value="å®Œäº†">å®Œäº†</option>
                </select>
                <button class="delete-task-btn" title="ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤">ğŸ—‘ï¸</button>
            </div>
        </div>
    </template>
    
    <template id="task-template-card">
        <div class="kanban-card" data-priority="B">
            <button class="delete-task-btn" title="ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤">ğŸ—‘ï¸</button> <div class="task-subject">ç§‘ç›®å</div>
            <div class="task-name">ã‚¿ã‚¹ã‚¯è©³ç´°</div>
            <div class="task-controls">
                <select class="task-priority-select" title="å„ªå…ˆåº¦">
                    <option value="S">S (æœ€é«˜)</option>
                    <option value="A">A (é«˜ã„)</option>
                    <option value="B">B (æ™®é€š)</option>
                    <option value="C">C (ä½ã„)</option>
                </select>
                <select class="task-status-select" title="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">
                    <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
                    <option value="ä½œæ¥­ä¸­">ä½œæ¥­ä¸­</option>
                    <option value="å®Œäº†">å®Œäº†</option>
                </select>
            </div>
        </div>
    </template>


    <script>
        // === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ===
        let allDefaultTasks = {};
        let tasks = []; // ç¾åœ¨è¡¨ç¤ºä¸­ã®æœˆã®ã‚¿ã‚¹ã‚¯é…åˆ—
        let currentMonth = "11";
        let currentViewMode = "list"; // 'list' or 'board'
        const STORAGE_KEY_PREFIX = 'reportTasksData_';
        const deadlines = { "11": "11/15", "12": "12/15", "1": "1/15", "2": "2/15", "3": "3/15" };
        const priorityOrder = { "S": 1, "A": 2, "B": 3, "C": 4 };

        // === DOMè¦ç´ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ===
        const allPages = document.querySelectorAll('.page');
        const navTabs = document.querySelectorAll('.nav-tab');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        // ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼
        const taskListContainer = document.getElementById('task-list');
        const kanbanBoard = document.getElementById('kanban-board');
        const kanbanCols = {
            "æœªç€æ‰‹": document.getElementById('kanban-col-todo'),
            "ä½œæ¥­ä¸­": document.getElementById('kanban-col-doing'),
            "å®Œäº†": document.getElementById('kanban-col-done')
        };
        const taskTemplateList = document.getElementById('task-template-list');
        const taskTemplateCard = document.getElementById('task-template-card');
        const progressSummary = document.getElementById('progress-summary');
        const progressBar = document.getElementById('progress-bar');
        const resetButton = document.getElementById('reset-button');
        const exportDataBtn = document.getElementById('export-data-btn');
        const monthSelector = document.getElementById('month-selector');
        const mainTitle = document.getElementById('main-title');
        const deadlineDisplay = document.getElementById('deadline-display');
        const viewModeToggle = document.getElementById('view-mode-toggle');
        // ãƒ¢ãƒ¼ãƒ€ãƒ«
        const addTaskBtn = document.getElementById('add-task-btn');
        const addTaskModal = document.getElementById('add-task-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const addTaskForm = document.getElementById('add-task-form');
        // ã‚¿ã‚¤ãƒãƒ¼
        const timerDisplay = document.getElementById('timer-display');
        const timerModeDisplay = document.getElementById('timer-mode');
        const timerStartPauseBtn = document.getElementById('timer-start-pause');
        const timerResetBtn = document.getElementById('timer-reset');


        // === 1. ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å‡¦ç† ===
        document.addEventListener('DOMContentLoaded', async () => {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚§ãƒƒãƒ
            await fetchDefaultTasks();
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelector('nav').addEventListener('click', (e) => {
                if (e.target.matches('.nav-tab')) {
                    showPage(e.target.dataset.page);
                }
            });
            
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
            darkModeToggle.addEventListener('click', toggleDarkMode);
            loadTheme(); // ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã‚€

            // --- ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼é–¢é€£ ---
            monthSelector.addEventListener('click', (e) => {
                if (e.target.matches('.month-tab')) {
                    switchMonth(e.target.dataset.month);
                }
            });
            
            resetButton.addEventListener('click', resetProgress);
            exportDataBtn.addEventListener('click', exportAllData);
            viewModeToggle.addEventListener('change', (e) => switchViewMode(e.target.value));

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
            addTaskBtn.addEventListener('click', () => addTaskModal.showModal());
            closeModalBtn.addEventListener('click', () => addTaskModal.close());
            addTaskForm.addEventListener('submit', handleAddTask);
            
            // --- ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ ---
            timerStartPauseBtn.addEventListener('click', timer.startPause);
            timerResetBtn.addEventListener('click', timer.reset);
            
            // --- åˆæœŸè¡¨ç¤º ---
            switchMonth(currentMonth); // 11æœˆã§åˆæœŸåŒ–
            showPage('planner'); // ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã‚’æœ€åˆã«è¡¨ç¤º
        });
        
        // === 2. ãƒšãƒ¼ã‚¸åˆ‡æ›¿ãƒ­ã‚¸ãƒƒã‚¯ ===
        function showPage(pageId) {
            allPages.forEach(page => page.classList.toggle('active', page.id === `page-${pageId}`));
            navTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.page === pageId));
        }

        // === 3. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ ===
        function toggleDarkMode() {
            const currentTheme = document.body.dataset.theme;
            const newTheme = (currentTheme === 'dark') ? 'light' : 'dark';
            setTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }
        function setTheme(theme) {
            document.body.dataset.theme = theme;
            darkModeToggle.textContent = (theme === 'dark') ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        // === 4. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ãƒ‡ãƒ¼ã‚¿ç®¡ç† ===
        async function fetchDefaultTasks() {
            try {
                const response = await fetch(`tasks.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('JSONèª­ã¿è¾¼ã¿å¤±æ•—');
                allDefaultTasks = await response.json();
            } catch (error) {
                console.error(error);
                mainTitle.textContent = "ã‚¨ãƒ©ãƒ¼: tasks.json ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“";
            }
        }

        function switchMonth(month) {
            currentMonth = month;
            mainTitle.textContent = `${month}æœˆåˆ† ãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ãƒŠãƒ¼`;
            deadlineDisplay.textContent = `ç· ã‚åˆ‡ã‚Š: ${deadlines[currentMonth] || '--/--'}`;
            
            monthSelector.querySelectorAll('.month-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.month === month);
            });
            
            loadTasksForCurrentMonth();
        }

        function loadTasksForCurrentMonth() {
            const STORAGE_KEY = STORAGE_KEY_PREFIX + currentMonth;
            const savedData = localStorage.getItem(STORAGE_KEY);
            
            if (savedData) {
                tasks = JSON.parse(savedData);
            } else {
                tasks = allDefaultTasks[currentMonth] ? JSON.parse(JSON.stringify(allDefaultTasks[currentMonth])) : [];
                if (tasks.length > 0) saveTasks(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä¿å­˜
            }
            renderTasks();
        }

        function saveTasks() {
            const STORAGE_KEY = STORAGE_KEY_PREFIX + currentMonth;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        }

        function resetProgress() {
            if (confirm(`ã€${currentMonth}æœˆã€‘ã®é€²æ—ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚\n(è¿½åŠ ã—ãŸã‚¿ã‚¹ã‚¯ã‚‚æ¶ˆãˆã€JSONã®åˆæœŸçŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™)\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                localStorage.removeItem(STORAGE_KEY_PREFIX + currentMonth);
                loadTasksForCurrentMonth();
            }
        }
        
        // === 5. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ã‚¿ã‚¹ã‚¯ã®CRUD (è¿½åŠ ãƒ»å‰Šé™¤ãƒ»å¤‰æ›´) ===
        
        function handleAddTask(e) {
            e.preventDefault();
            const subject = document.getElementById('task-subject').value;
            const name = document.getElementById('task-name').value;
            const priority = document.getElementById('task-priority').value;
            
            // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆ (ç¾åœ¨æ™‚åˆ»ã®ãƒŸãƒªç§’)
            const newId = Date.now(); 
            
            const newTask = {
                id: newId,
                subject: subject,
                taskName: name,
                priority: priority,
                status: "æœªç€æ‰‹"
            };
            
            tasks.push(newTask);
            saveTasks();
            renderTasks(); // ãƒªã‚¹ãƒˆã‚’å†æç”»
            
            addTaskModal.close(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            addTaskForm.reset(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        }
        
        function handleDeleteTask(taskId) {
            if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                renderTasks(); // å‰Šé™¤ã‚’åæ˜ 
            }
        }

        function handleStatusChange(taskId, newStatus) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = newStatus;
                saveTasks();
                // å…¨ä½“ã‚’å†æç”» (ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ã®ç§»å‹•ã‚’åæ˜ ã™ã‚‹ãŸã‚)
                renderTasks();
            }
        }

        function handlePriorityChange(taskId, newPriority) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.priority = newPriority;
                saveTasks();
                // å„ªå…ˆåº¦ã‚½ãƒ¼ãƒˆã‚’åæ˜ ã™ã‚‹ãŸã‚å†æç”»
                renderTasks();
            }
        }

        // === 6. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: æç”»ãƒ­ã‚¸ãƒƒã‚¯ ===
        
        function switchViewMode(mode) {
            currentViewMode = mode;
            if (mode === 'list') {
                taskListContainer.style.display = 'block';
                kanbanBoard.style.display = 'none';
            } else {
                taskListContainer.style.display = 'none';
                kanbanBoard.style.display = 'flex';
            }
            renderTasks(); // ãƒ“ãƒ¥ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã¦å†æç”»
        }

        function renderTasks() {
            // å¸¸ã«å„ªå…ˆåº¦ã§ã‚½ãƒ¼ãƒˆ
            tasks.sort((a, b) => {
                return (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99);
            });
            
            if (currentViewMode === 'list') {
                renderListView();
            } else {
                renderBoardView();
            }
            updateSummary();
        }

        function renderListView() {
            taskListContainer.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            tasks.forEach(task => {
                const taskElement = document.importNode(taskTemplateList.content, true);
                
                // ãƒ‡ãƒ¼ã‚¿è¨­å®š
                const itemDiv = taskElement.querySelector('.task-item');
                itemDiv.dataset.status = task.status;
                
                taskElement.querySelector('.task-subject').textContent = task.subject;
                taskElement.querySelector('.task-name').textContent = task.taskName;
                
                const prioritySelect = taskElement.querySelector('.task-priority-select');
                prioritySelect.value = task.priority;
                prioritySelect.dataset.priority = task.priority;
                
                const statusSelect = taskElement.querySelector('.task-status-select');
                statusSelect.value = task.status;
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                prioritySelect.addEventListener('change', () => handlePriorityChange(task.id, prioritySelect.value));
                statusSelect.addEventListener('change', () => handleStatusChange(task.id, statusSelect.value));
                taskElement.querySelector('.delete-task-btn').addEventListener('click', () => handleDeleteTask(task.id));
                
                taskListContainer.appendChild(taskElement);
            });
        }
        
        function renderBoardView() {
            // 3ã¤ã®ã‚«ãƒ©ãƒ ã‚’ä¸€åº¦ã‚¯ãƒªã‚¢
            Object.values(kanbanCols).forEach(col => col.innerHTML = '');
            
            tasks.forEach(task => {
                const taskCard = document.importNode(taskTemplateCard.content, true);
                
                // ãƒ‡ãƒ¼ã‚¿è¨­å®š
                const cardDiv = taskCard.querySelector('.kanban-card');
                cardDiv.dataset.priority = task.priority;
                
                taskCard.querySelector('.task-subject').textContent = task.subject;
                taskCard.querySelector('.task-name').textContent = task.taskName;
                
                const prioritySelect = taskCard.querySelector('.task-priority-select');
                prioritySelect.value = task.priority;
                prioritySelect.dataset.priority = task.priority;
                
                const statusSelect = taskCard.querySelector('.task-status-select');
                statusSelect.value = task.status;

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                prioritySelect.addEventListener('change', () => handlePriorityChange(task.id, prioritySelect.value));
                statusSelect.addEventListener('change', () => handleStatusChange(task.id, statusSelect.value));
                taskCard.querySelector('.delete-task-btn').addEventListener('click', () => handleDeleteTask(task.id));
                
                // è©²å½“ã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚«ãƒ©ãƒ ã«è¿½åŠ 
                if (kanbanCols[task.status]) {
                    kanbanCols[task.status].appendChild(taskCard);
                }
            });
        }

        function updateSummary() {
            const completedCount = tasks.filter(t => t.status === 'å®Œäº†').length;
            const totalCount = tasks.length;
            progressSummary.textContent = `é€²æ—: ${completedCount} / ${totalCount} å®Œäº†`;
            
            const percentage = (totalCount > 0) ? (completedCount / totalCount) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
        }
        
        // === 7. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã— (JSONç”Ÿæˆ) ===
        function exportAllData() {
            if (!confirm('ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…¨æœˆã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            let allData = {};
            // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ï¼ˆ11, 12, 1, 2, 3æœˆï¼‰ã‚’ãƒ«ãƒ¼ãƒ—
            const monthsToExport = ["11", "12", "1", "2", "3"];
            
            monthsToExport.forEach(month => {
                const storageKey = STORAGE_KEY_PREFIX + month;
                const savedData = localStorage.getItem(storageKey);
                
                if (savedData) {
                    allData[month] = JSON.parse(savedData);
                } else {
                    // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€JSONã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰ã‚’å…¥ã‚Œã‚‹
                    allData[month] = allDefaultTasks[month] ? allDefaultTasks[month] : [];
                }
            });
            
            const dataStr = JSON.stringify(allData, null, 2); // è¦‹ã‚„ã™ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportLink = document.createElement('a');
            exportLink.setAttribute('href', dataUri);
            exportLink.setAttribute('download', 'report_data.json');
            exportLink.click();
        }

        // === 8. ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ ===
        const timer = {
            isRunning: false,
            intervalId: null,
            time: 25 * 60, // 25åˆ† (ç§’)
            mode: 'work', // 'work' or 'break'
            
            startPause() {
                if (this.isRunning) {
                    // ä¸€æ™‚åœæ­¢
                    clearInterval(this.intervalId);
                    timerStartPauseBtn.textContent = 'å†é–‹';
                } else {
                    // é–‹å§‹ãƒ»å†é–‹
                    timerStartPauseBtn.textContent = 'ä¸€æ™‚åœæ­¢';
                    this.intervalId = setInterval(() => this.update(), 1000);
                }
                this.isRunning = !this.isRunning;
            },
            
            update() {
                this.time--;
                if (this.time < 0) {
                    this.complete();
                }
                this.display();
            },
            
            display() {
                const minutes = Math.floor(this.time / 60).toString().padStart(2, '0');
                const seconds = (this.time % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
                document.title = `${minutes}:${seconds} - ${this.mode === 'work' ? 'å‹‰å¼·ä¸­' : 'ä¼‘æ†©ä¸­'}`;
            },
            
            reset() {
                if (confirm('ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.setMode('work');
                    this.display();
                }
            },
            
            complete() {
                clearInterval(this.intervalId);
                this.isRunning = false;
                this.playBeep();
                
                if (this.mode === 'work') {
                    this.setMode('break');
                    alert('ãŠç–²ã‚Œæ§˜ã§ã™ï¼ 5åˆ†é–“ã®ä¼‘æ†©ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
                } else {
                    this.setMode('work');
                    alert('ä¼‘æ†©çµ‚äº†ã§ã™ã€‚å‹‰å¼·ã‚’å†é–‹ã—ã¾ã—ã‚‡ã†ï¼');
                }
                timerStartPauseBtn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
            },
            
            setMode(mode) {
                this.mode = mode;
                if (mode === 'work') {
                    this.time = 25 * 60;
                    timerModeDisplay.textContent = 'å‹‰å¼· (25åˆ†)';
                    timerDisplay.style.color = 'var(--color-primary)';
                } else {
                    this.time = 5 * 60;
                    timerModeDisplay.textContent = 'ä¼‘æ†© (5åˆ†)';
                    timerDisplay.style.color = 'var(--color-success)';
                }
                this.display();
            },
            
            playBeep() {
                // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ“ãƒ¼ãƒ—éŸ³ã‚’å†ç”Ÿ
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // 440Hz (ãƒ©)
                    oscillator.connect(audioContext.destination);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5); // 0.5ç§’é³´ã‚‰ã™
                } catch(e) {
                    console.error("ãƒ“ãƒ¼ãƒ—éŸ³ã®å†ç”Ÿã«å¤±æ•—:", e);
                }
            }
        };

    </script>
</body>
</html>
