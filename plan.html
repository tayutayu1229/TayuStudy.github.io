<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€å¼·ã‚¹ã‚¿ãƒ‡ã‚£ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

    <style>
        /* === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° === */
        :root {
            --color-bg: #f4f7f6;
            --color-surface: #ffffff;
            --color-text-primary: #2a2a2a;
            --color-text-secondary: #555;
            --color-border: #eee;
            --color-border-input: #ccc;
            --color-primary: #007bff;
            --color-primary-hover: #0056b3;
            --color-danger: #dc3545;
            --color-danger-hover: #c82333;
            --color-success: #28a745;
            --color-warning: #fd7e14;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* === ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ === */
        body[data-theme="dark"] {
            --color-bg: #121212;
            --color-surface: #1e1e1e;
            --color-text-primary: #f1f1f1;
            --color-text-secondary: #aaa;
            --color-border: #333;
            --color-border-input: #555;
        }

        /* === åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« === */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Noto Sans CJK JP', 'Yu Gothic', Meiryo, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--color-surface);
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: background-color 0.3s;
        }
        main { padding: 20px 30px 30px; }
        h1 { margin: 0; font-size: 1.8em; }
        h2 { margin: 10px 0; font-weight: 600; border-bottom: 2px solid var(--color-border); padding-bottom: 10px; }
        h3 { margin: 0 0 15px 0; color: var(--color-primary); }
        button, .btn {
            cursor: pointer; padding: 8px 14px; border: none; border-radius: 6px;
            font-weight: 600; transition: background-color 0.2s, opacity 0.2s;
            text-decoration: none; display: inline-block;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-danger:hover { background-color: var(--color-danger-hover); }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-print { background-color: #5a189a; color: white; }
        .btn-print:hover { background-color: #3c096c; }

        input, select, textarea {
            background-color: var(--color-surface);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-input);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        textarea { width: 100%; min-height: 300px; font-family: inherit; }
        
        /* === ãƒšãƒ¼ã‚¸åˆ‡æ›¿ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ === */
        nav {
            background-color: var(--color-bg);
            padding: 15px 30px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        nav .nav-tabs button {
            background: none; border: none; padding: 10px 15px; font-size: 1.1em;
            font-weight: 600; color: var(--color-text-secondary);
            border-bottom: 3px solid transparent;
        }
        nav .nav-tabs button.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }

        .page { display: none; }
        .page.active { display: block; }

        /* === 1. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãƒšãƒ¼ã‚¸ === */
        #page-planner header { border-bottom: 1px solid var(--color-border); padding-bottom: 20px; margin-bottom: 20px; }
        #deadline-display { font-size: 1.2em; color: var(--color-danger); }
        #month-selector { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .month-tab {
            padding: 10px 20px; border: 1px solid var(--color-border-input); border-radius: 8px;
            background-color: var(--color-bg); font-weight: 600; color: var(--color-text-secondary);
        }
        .month-tab:hover { background-color: var(--color-border); }
        .month-tab.active { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
        #progress-summary { font-size: 1.1em; font-weight: 600; margin-top: 20px; color: var(--color-primary); }
        #progress-bar-container { width: 100%; background-color: var(--color-border); border-radius: 4px; height: 10px; margin-top: 8px; overflow: hidden; }
        #progress-bar { height: 100%; width: 0%; background-color: var(--color-primary); border-radius: 4px; transition: width 0.5s ease; }

        /* ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éƒ¨ */
        #planner-controls {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            margin-bottom: 20px; gap: 15px;
        }
        .control-group { display: flex; gap: 10px; align-items: center; }
        .control-group label { font-weight: 600; font-size: 0.9em; }
        #search-task { width: 160px; }

        /* ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
        .task-item {
            display: flex; align-items: center; padding: 20px 0;
            border-bottom: 1px solid var(--color-border);
            transition: opacity 0.3s, background-color 0.3s, max-height 0.3s, padding 0.3s;
            overflow: hidden;
        }
        .task-item.hidden { max-height: 0; padding-top: 0; padding-bottom: 0; opacity: 0; border: 0; }
        .task-item[data-status="å®Œäº†"] { opacity: 0.6; }
        .task-item[data-status="å®Œäº†"] .task-details { text-decoration: line-through; color: var(--color-text-secondary); }
        .task-item[data-status="ä½œæ¥­ä¸­"] { background-color: rgba(0, 123, 255, 0.05); }
        body[data-theme="dark"] .task-item[data-status="ä½œæ¥­ä¸­"] { background-color: rgba(0, 123, 255, 0.1); }
        .task-details { flex-grow: 1; margin-right: 15px; }
        .task-subject { font-weight: 600; font-size: 1.1em; margin-bottom: 5px; }
        .task-name { font-size: 0.9em; color: var(--color-text-secondary); }
        
        .task-completion-date {
            font-size: 0.8em;
            font-style: italic;
            color: var(--color-success);
            margin-top: 5px;
        }
        
        .task-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .task-status-select, .task-priority-select {
            padding: 8px 12px; border-radius: 6px; border: 1px solid var(--color-border-input);
            background-color: var(--color-surface); color: var(--color-text-primary);
            font-size: 0.9em; cursor: pointer;
        }
        .task-priority-select[data-priority="S"] { border-color: var(--color-danger); background-color: rgba(220, 53, 69, 0.1); }
        .task-priority-select[data-priority="A"] { border-color: var(--color-warning); background-color: rgba(253, 126, 20, 0.1); }
        .task-priority-select[data-priority="B"] { border-color: var(--color-primary); background-color: rgba(0, 123, 255, 0.1); }
        .task-priority-select[data-priority="C"] { border-color: var(--color-success); background-color: rgba(40, 167, 69, 0.1); }
        .edit-task-btn { background: none; border: none; font-size: 1.2em; color: var(--color-text-secondary); padding: 5px; opacity: 0.7; }
        .edit-task-btn:hover { color: var(--color-primary); opacity: 1; }

        /* ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ */
        #kanban-board { display: none; gap: 15px; overflow-x: auto; padding: 10px 0; min-height: 400px; }
        .kanban-column { flex: 1; min-width: 280px; background-color: var(--color-bg); border-radius: 8px; padding: 15px; }
        .kanban-column h3 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid var(--color-border); color: var(--color-text-primary); }
        .kanban-column[data-status="æœªç€æ‰‹"] { border-top: 3px solid var(--color-danger); }
        .kanban-column[data-status="ä½œæ¥­ä¸­"] { border-top: 3px solid var(--color-primary); }
        .kanban-column[data-status="å®Œäº†"] { border-top: 3px solid var(--color-success); }
        .kanban-card-list { display: flex; flex-direction: column; gap: 10px; }
        .kanban-card {
            background-color: var(--color-surface); border-radius: 6px; padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid;
            position: relative;
        }
        .kanban-card[data-priority="S"] { border-left-color: var(--color-danger); }
        .kanban-card[data-priority="A"] { border-left-color: var(--color-warning); }
        .kanban-card[data-priority="B"] { border-left-color: var(--color-primary); }
        .kanban-card[data-priority="C"] { border-left-color: var(--color-success); }
        .kanban-card .task-subject { font-size: 1em; }
        .kanban-card .task-name { font-size: 0.85em; }
        .kanban-card .task-completion-date { font-size: 0.75em; }
        .kanban-card .task-controls { margin-top: 10px; flex-direction: column; gap: 5px; }
        .kanban-card .task-status-select, .kanban-card .task-priority-select { padding: 5px 8px; width: 100%; }
        .kanban-card .edit-task-btn { position: absolute; top: 5px; right: 5px; }

        /* ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ãƒ•ãƒƒã‚¿ãƒ¼ */
        #planner-footer {
            padding: 20px 30px; border-top: 1px solid var(--color-border);
            background-color: var(--color-bg); display: flex; flex-wrap: wrap; gap: 10px;
        }
        .btn-import { background-color: var(--color-success); color: white; }
        .btn-import:hover { background-color: #218838; }
        #import-file-input { display: none; }

        /* === 2. ã‚¿ã‚¤ãƒãƒ¼ãƒšãƒ¼ã‚¸ === */
        #page-timer { text-align: center; padding: 40px 30px; }
        #timer-display { font-size: 6em; font-weight: 200; margin: 20px 0; color: var(--color-primary); }
        #timer-mode-select { margin-bottom: 20px; }
        #custom-timer-inputs { display: none; gap: 10px; justify-content: center; margin-top: 10px; }
        #custom-timer-inputs input { width: 60px; }
        #timer-controls { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
        #timer-controls button { font-size: 1.1em; padding: 12px 25px; }

        /* === 3. ã‚°ãƒ©ãƒ•ãƒšãƒ¼ã‚¸ === */
        #page-graph .chart-container {
            margin-bottom: 30px; padding: 20px;
            background: var(--color-bg); border-radius: 8px;
        }
        .bar-chart { display: flex; gap: 10px; align-items: flex-end; height: 150px; border-bottom: 2px solid var(--color-border-input); }
        .bar { width: 100%; background-color: var(--color-primary); text-align: center; color: white; font-weight: bold; position: relative; }
        .bar .label { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 0.9em; color: var(--color-text-secondary); }
        .bar .value { font-size: 0.8em; padding-top: 5px; }
        .pie-chart-container { display: flex; gap: 20px; align-items: center; }
        .pie-chart { width: 150px; height: 150px; border-radius: 50%; background: conic-gradient(var(--color-danger) 0% 25%, var(--color-warning) 25% 50%, var(--color-primary) 50% 75%, var(--color-success) 75% 100%); }
        .pie-legend { display: flex; flex-direction: column; gap: 8px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        .legend-color { width: 16px; height: 16px; border-radius: 3px; }

        /* === 4. ãƒ¡ãƒ¢å¸³ãƒšãƒ¼ã‚¸ === */
        #page-memo { padding: 0 30px 30px; }
        #memo-pad { background-color: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border-input); }

        /* === ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š === */
        dialog {
            border: none; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 0; max-width: 500px; width: 90%;
            background-color: var(--color-surface); color: var(--color-text-primary);
        }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(3px); }
        .modal-content { padding: 30px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .close-modal-btn { background: none; border: none; font-size: 1.5em; color: var(--color-text-secondary); }
        form { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: 600; }
        .form-group input, .form-group select { width: 100%; }
        .modal-footer { margin-top: 25px; display: flex; justify-content: space-between; align-items: center; }
        
    </style>

    <style id="print-styles" type="text/css">
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Noto Sans CJK JP', 'Yu Gothic', Meiryo, sans-serif;
            margin: 20mm;
            font-size: 10pt;
        }
        @page {
            size: A4 portrait;
            margin: 20mm;
        }
        h1 {
            font-size: 18pt;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            color: #000;
        }
        .header-info {
            display: flex;
            justify-content: space-between;
            font-size: 11pt;
            margin-bottom: 20px;
            color: #000;
        }
        .header-info .deadline { font-weight: bold; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #999;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            word-break: break-all;
            color: #000;
        }
        th {
            background-color: #f0f0f0;
            font-size: 9pt;
        }
        th:nth-child(1) { width: 18%; } /* ç§‘ç›® */
        th:nth-child(2) { width: 35%; } /* ã‚¿ã‚¹ã‚¯å†…å®¹ */
        th:nth-child(3) { width: 8%; }  /* å„ªå…ˆåº¦ */
        th:nth-child(4) { width: 12%; } /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        th:nth-child(5) { width: 27%; } /* å®Œäº†æ—¥æ™‚ */
    </style>

</head>
<body data-theme="light">

    <div class="container">

        <nav>
            <div class="nav-tabs">
                <button class="nav-tab active" data-page="planner">ğŸ“– ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</button>
                <button class="nav-tab" data-page="timer">â±ï¸ ã‚¿ã‚¤ãƒãƒ¼</button>
                <button class="nav-tab" data-page="graph">ğŸ“Š ã‚°ãƒ©ãƒ•</button>
                <button class="nav-tab" data-page="memo">ğŸ“ ãƒ¡ãƒ¢å¸³</button>
            </div>
            <div class="nav-controls">
                <button id="dark-mode-toggle" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">â˜€ï¸</button>
            </div>
        </nav>

        <main id="page-planner" class="page active">
            <header>
                <h1 id="main-title">ãƒ¬ãƒãƒ¼ãƒˆé€²æ—ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
                <h2 id="deadline-display">ç· ã‚åˆ‡ã‚Š: --/--</h2>
                <div id="month-selector">
                    <button class="month-tab" data-month="11">11æœˆ</button>
                    <button class="month-tab" data-month="12">12æœˆ</button>
                    <button class="month-tab" data-month="1">1æœˆ</button>
                    <button class="month-tab" data-month="2">2æœˆ</button>
                    <button class="month-tab" data-month="3">3æœˆ</button>
                </div>
                <div id="progress-summary">é€²æ—: 0 / 0 å®Œäº†</div>
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
            </header>
            <div id="planner-controls">
                <div class="control-group">
                    <label for="view-mode-toggle">è¡¨ç¤º:</label>
                    <select id="view-mode-toggle">
                        <option value="list">ãƒªã‚¹ãƒˆè¡¨ç¤º</option>
                        <option value="board">ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰è¡¨ç¤º</option>
                    </select>
                </div>
                <div class="control-group">
                    <input type="text" id="search-task" placeholder="ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢...">
                    <input type="checkbox" id="hide-completed-toggle">
                    <label for="hide-completed-toggle">å®Œäº†ã‚’éš ã™</label>
                </div>
                <button id="add-task-btn" class="btn-primary">ï¼‹ ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
            </div>
            <section id="task-display-area">
                <div id="task-list"></div>
                <div id="kanban-board">
                    <div class="kanban-column" data-status="æœªç€æ‰‹"><h3>æœªç€æ‰‹</h3><div class="kanban-card-list" id="kanban-col-todo"></div></div>
                    <div class="kanban-column" data-status="ä½œæ¥­ä¸­"><h3>ä½œæ¥­ä¸­</h3><div class="kanban-card-list" id="kanban-col-doing"></div></div>
                    <div class="kanban-column" data-status="å®Œäº†"><h3>å®Œäº†</h3><div class="kanban-card-list" id="kanban-col-done"></div></div>
                </div>
            </section>
            
            <footer id="planner-footer">
                <button id="export-data-btn" class="btn-secondary">å…¨ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã— (Export)</button>
                <label for="import-file-input" class="btn btn-import">å…¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ (Import)</label>
                <input type="file" id="import-file-input" accept=".json">
                <button id="print-report-btn" class="btn-print">ä»Šæœˆã®ãƒ¬ãƒãƒ¼ãƒˆã‚’å°åˆ· ğŸ“„</button>
            </footer>
        </main>

        <main id="page-timer" class="page">
            <h2>ã‚¿ã‚¤ãƒãƒ¼è¨­å®š</h2>
            <select id="timer-mode-select">
                <option value="pomodoro">ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ (25åˆ† / 5åˆ†)</option>
                <option value="focus">é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ (45åˆ† / 10åˆ†)</option>
                <option value="short">çŸ­æ™‚é–“ (15åˆ† / 3åˆ†)</option>
                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
            </select>
            <div id="custom-timer-inputs">
                <label>å‹‰å¼·:<input type="number" id="custom-work-time" value="25" min="1">åˆ†</label>
                <label>ä¼‘æ†©:<input type="number" id="custom-break-time" value="5" min="1">åˆ†</label>
            </div>
            <h3 id="timer-mode-display">å‹‰å¼· (25åˆ†)</h3>
            <div id="timer-display">25:00</div>
            <div id="timer-controls">
                <button id="timer-start-pause" class="btn-primary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                <button id="timer-reset" class="btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </main>
        
        <main id="page-graph" class="page">
            <h2>é€²æ—ã‚°ãƒ©ãƒ•</h2>
            <div class="chart-container">
                <h3>æœˆåˆ¥ å®Œäº†ã‚¿ã‚¹ã‚¯æ•°</h3>
                <div class="bar-chart" id="monthly-completion-chart"></div>
            </div>
            <div class="chart-container">
                <h3>å…¨ã‚¿ã‚¹ã‚¯ å„ªå…ˆåº¦åˆ¥</h3>
                <div class="pie-chart-container" id="priority-pie-chart">
                    <div class="pie-chart" id="priority-pie"></div>
                    <div class="pie-legend" id="priority-pie-legend"></div>
                </div>
            </div>
        </main>
        
        <main id="page-memo" class="page">
            <h2>ãƒ•ãƒªãƒ¼ãƒ¡ãƒ¢å¸³</h2>
            <p style="color: var(--color-text-secondary); font-size: 0.9em;">å…¥åŠ›ã•ã‚ŒãŸå†…å®¹ã¯è‡ªå‹•ã§ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
            <textarea id="memo-pad" placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
        </main>

    </div> <dialog id="add-task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h2>
                <button class="close-modal-btn">âœ•</button>
            </div>
            <form id="add-task-form">
                <div class="form-group">
                    <label for="task-subject">ç§‘ç›®</label>
                    <input type="text" id="task-subject" required>
                </div>
                <div class="form-group">
                    <label for="task-name">ã‚¿ã‚¹ã‚¯å†…å®¹</label>
                    <input type="text" id="task-name" required>
                </div>
                <div class="form-group">
                    <label for="task-priority">å„ªå…ˆåº¦</label>
                    <select id="task-priority">
                        <option value="S">S (æœ€é«˜)</option>
                        <option value="A">A (é«˜ã„)</option>
                        <option value="B" selected>B (æ™®é€š)</option>
                        <option value="C">C (ä½ã„)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-primary">è¿½åŠ ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </dialog>
    
    <dialog id="edit-task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†</h2>
                <button class="close-modal-btn">âœ•</button>
            </div>
            <form id="edit-task-form">
                <div class="form-group">
                    <label for="edit-task-subject">ç§‘ç›®</label>
                    <input type="text" id="edit-task-subject" required>
                </div>
                <div class="form-group">
                    <label for="edit-task-name">ã‚¿ã‚¹ã‚¯å†…å®¹</label>
                    <input type="text" id="edit-task-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-task-priority">å„ªå…ˆåº¦</label>
                    <select id="edit-task-priority">
                        <option value="S">S (æœ€é«˜)</option>
                        <option value="A">A (é«˜ã„)</option>
                        <option value="B">B (æ™®é€š)</option>
                        <option value="C">C (ä½ã„)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-task-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select id="edit-task-status">
                        <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
                        <option value="ä½œæ¥­ä¸­">ä½œæ¥­ä¸­</option>
                        <option value="å®Œäº†">å®Œäº†</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" id="delete-task-3confirm-btn" class="btn-danger">å‰Šé™¤</button>
                    <button type="submit" class="btn-primary">ä¿å­˜ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </dialog>

    <template id="task-template-list">
        <div class="task-item" data-status="æœªç€æ‰‹">
            <div class="task-details">
                <div class="task-subject">ç§‘ç›®å</div>
                <div class="task-name">ã‚¿ã‚¹ã‚¯è©³ç´°</div>
                <div class="task-completion-date"></div>
            </div>
            <div class="task-controls">
                <select class="task-priority-select" title="å„ªå…ˆåº¦">
                    <option value="S">S (æœ€é«˜)</option>
                    <option value="A">A (é«˜ã„)</option>
                    <option value="B">B (æ™®é€š)</option>
                    <option value="C">C (ä½ã„)</option>
                </select>
                <select class="task-status-select" title="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">
                    <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
                    <option value="ä½œæ¥­ä¸­">ä½œæ¥­ä¸­</option>
                    <option value="å®Œäº†">å®Œäº†</option>
                </select>
                <button class="edit-task-btn" title="ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†">âœï¸</button>
            </div>
        </div>
    </template>
    
    <template id="task-template-card">
        <div class="kanban-card" data-priority="B">
            <button class="edit-task-btn" title="ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†">âœï¸</button>
            <div class="task-subject">ç§‘ç›®å</div>
            <div class="task-name">ã‚¿ã‚¹ã‚¯è©³ç´°</div>
            <div class="task-completion-date"></div>
            <div class="task-controls">
                <select class="task-priority-select" title="å„ªå…ˆåº¦">
                    <option value="S">S (æœ€é«˜)</option>
                    <option value="A">A (é«˜ã„)</option>
                    <option value="B">B (æ™®é€š)</option>
                    <option value="C">C (ä½ã„)</option>
                </select>
                <select class="task-status-select" title="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">
                    <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
                    <option value="ä½œæ¥­ä¸­">ä½œæ¥­ä¸­</option>
                    <option value="å®Œäº†">å®Œäº†</option>
                </select>
            </div>
        </div>
    </template>


    <script>
        // === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (V4ã¨åŒã˜) ===
        let allDefaultTasks = {};
        let tasks = [];
        let currentMonth = "11";
        let currentViewMode = "list";
        let currentEditingTaskId = null;
        const STORAGE_KEY_PREFIX = 'reportTasksData_';
        const MEMO_KEY = 'studyDashboardMemo';
        const THEME_KEY = 'studyDashboardTheme';
        const deadlines = { "11": "11/15", "12": "12/15", "1": "1/15", "2": "2/15", "3": "3/15" };
        const priorityOrder = { "S": 1, "A": 2, "B": 3, "C": 4 };
        const priorityColors = { "S": "var(--color-danger)", "A": "var(--color-warning)", "B": "var(--color-primary)", "C": "var(--color-success)" };
        const MONTHS = ["11", "12", "1", "2", "3"];

        // === DOMè¦ç´ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (V4ã¨åŒã˜) ===
        const allPages = document.querySelectorAll('.page');
        const navTabs = document.querySelectorAll('.nav-tab');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const taskListContainer = document.getElementById('task-list');
        const kanbanBoard = document.getElementById('kanban-board');
        const kanbanCols = { "æœªç€æ‰‹": document.getElementById('kanban-col-todo'), "ä½œæ¥­ä¸­": document.getElementById('kanban-col-doing'), "å®Œäº†": document.getElementById('kanban-col-done') };
        const taskTemplateList = document.getElementById('task-template-list');
        const taskTemplateCard = document.getElementById('task-template-card');
        const progressSummary = document.getElementById('progress-summary');
        const progressBar = document.getElementById('progress-bar');
        const exportDataBtn = document.getElementById('export-data-btn');
        const importFileInput = document.getElementById('import-file-input');
        const printReportBtn = document.getElementById('print-report-btn');
        const monthSelector = document.getElementById('month-selector');
        const mainTitle = document.getElementById('main-title');
        const deadlineDisplay = document.getElementById('deadline-display');
        const viewModeToggle = document.getElementById('view-mode-toggle');
        const searchInput = document.getElementById('search-task');
        const hideCompletedToggle = document.getElementById('hide-completed-toggle');
        const addTaskBtn = document.getElementById('add-task-btn');
        const addTaskModal = document.getElementById('add-task-modal');
        const addTaskForm = document.getElementById('add-task-form');
        const editTaskModal = document.getElementById('edit-task-modal');
        const editTaskForm = document.getElementById('edit-task-form');
        const delete3ConfirmBtn = document.getElementById('delete-task-3confirm-btn');
        const timerDisplay = document.getElementById('timer-display');
        const timerModeDisplay = document.getElementById('timer-mode-display');
        const timerStartPauseBtn = document.getElementById('timer-start-pause');
        const timerResetBtn = document.getElementById('timer-reset');
        const timerModeSelect = document.getElementById('timer-mode-select');
        const customTimerInputs = document.getElementById('custom-timer-inputs');
        const customWorkTime = document.getElementById('custom-work-time');
        const customBreakTime = document.getElementById('custom-break-time');
        const monthlyChartContainer = document.getElementById('monthly-completion-chart');
        const priorityPie = document.getElementById('priority-pie');
        const priorityPieLegend = document.getElementById('priority-pie-legend');
        const memoPad = document.getElementById('memo-pad');

        // === 1. ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å‡¦ç† (V4ã¨åŒã˜) ===
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchDefaultTasks();
            
            document.querySelector('nav').addEventListener('click', (e) => {
                if (e.target.matches('.nav-tab')) showPage(e.target.dataset.page);
            });
            
            darkModeToggle.addEventListener('click', toggleDarkMode);
            loadTheme();

            monthSelector.addEventListener('click', (e) => {
                if (e.target.matches('.month-tab')) switchMonth(e.target.dataset.month);
            });
            exportDataBtn.addEventListener('click', exportAllData);
            importFileInput.addEventListener('change', importData);
            printReportBtn.addEventListener('click', handlePrintReport); // â˜… å°åˆ·å‡¦ç†
            viewModeToggle.addEventListener('change', (e) => switchViewMode(e.target.value));
            searchInput.addEventListener('input', () => renderTasks(false));
            hideCompletedToggle.addEventListener('change', () => renderTasks(false));

            addTaskBtn.addEventListener('click', () => addTaskModal.showModal());
            addTaskModal.querySelector('.close-modal-btn').addEventListener('click', () => addTaskModal.close());
            addTaskForm.addEventListener('submit', handleAddTask);
            
            editTaskModal.querySelector('.close-modal-btn').addEventListener('click', () => editTaskModal.close());
            editTaskForm.addEventListener('submit', handleEditTask);
            delete3ConfirmBtn.addEventListener('click', handleDelete3Confirm);

            timerStartPauseBtn.addEventListener('click', timer.startPause);
            timerResetBtn.addEventListener('click', timer.reset);
            timerModeSelect.addEventListener('change', timer.selectMode);
            
            memoPad.addEventListener('input', saveMemo);
            loadMemo();

            switchMonth(currentMonth);
            showPage('planner');
        });
        
        // === 2. ãƒšãƒ¼ã‚¸åˆ‡æ›¿ãƒ­ã‚¸ãƒƒã‚¯ (V4ã¨åŒã˜) ===
        function showPage(pageId) {
            allPages.forEach(page => page.classList.toggle('active', page.id === `page-${pageId}`));
            navTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.page === pageId));
            if (pageId === 'graph') {
                renderGraphPage();
            }
        }

        // === 3. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ (V4ã¨åŒã˜) ===
        function toggleDarkMode() {
            const newTheme = (document.body.dataset.theme === 'dark') ? 'light' : 'dark';
            setTheme(newTheme);
            localStorage.setItem(THEME_KEY, newTheme);
        }
        function setTheme(theme) {
            document.body.dataset.theme = theme;
            darkModeToggle.textContent = (theme === 'dark') ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
            setTheme(savedTheme);
        }

        // === 4. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ãƒ‡ãƒ¼ã‚¿ç®¡ç† (V4ã¨åŒã˜) ===
        async function fetchDefaultTasks() {
            try {
                const response = await fetch(`tasks.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('JSONèª­ã¿è¾¼ã¿å¤±æ•—');
                allDefaultTasks = await response.json();
            } catch (error) {
                console.error(error);
                mainTitle.textContent = "ã‚¨ãƒ©ãƒ¼: tasks.json ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“";
            }
        }
        function switchMonth(month) {
            currentMonth = month;
            mainTitle.textContent = `${month}æœˆåˆ† ãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ãƒŠãƒ¼`;
            deadlineDisplay.textContent = `ç· ã‚åˆ‡ã‚Š: ${deadlines[currentMonth] || '--/--'}`;
            monthSelector.querySelectorAll('.month-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.month === month);
            });
            loadTasksForCurrentMonth();
        }
        function loadTasksForCurrentMonth() {
            const STORAGE_KEY = STORAGE_KEY_PREFIX + currentMonth;
            const savedData = localStorage.getItem(STORAGE_KEY);
            
            if (savedData) {
                tasks = JSON.parse(savedData);
            } else {
                tasks = allDefaultTasks[currentMonth] ? JSON.parse(JSON.stringify(allDefaultTasks[currentMonth])) : [];
                if (tasks.length > 0) saveTasks();
            }
            renderTasks(true);
        }
        function saveTasks() {
            localStorage.setItem(STORAGE_KEY_PREFIX + currentMonth, JSON.stringify(tasks));
        }

        // === 5. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ã‚¿ã‚¹ã‚¯ã®CRUD (V4ã¨åŒã˜) ===
        function handleAddTask(e) {
            e.preventDefault();
            const newTask = {
                id: Date.now(),
                subject: document.getElementById('task-subject').value,
                taskName: document.getElementById('task-name').value,
                priority: document.getElementById('task-priority').value,
                status: "æœªç€æ‰‹",
                completedAt: null
            };
            tasks.push(newTask);
            saveTasks();
            renderTasks(true);
            addTaskModal.close();
            addTaskForm.reset();
        }
        function openEditModal(task) {
            currentEditingTaskId = task.id;
            document.getElementById('edit-task-subject').value = task.subject;
            document.getElementById('edit-task-name').value = task.taskName;
            document.getElementById('edit-task-priority').value = task.priority;
            document.getElementById('edit-task-status').value = task.status;
            editTaskModal.showModal();
        }
        function handleEditTask(e) {
            e.preventDefault();
            const taskIndex = tasks.findIndex(t => t.id === currentEditingTaskId);
            if (taskIndex === -1) return;
            
            const oldStatus = tasks[taskIndex].status;
            const newStatus = document.getElementById('edit-task-status').value;
            let completedAt = tasks[taskIndex].completedAt;
            
            if (newStatus === 'å®Œäº†' && oldStatus !== 'å®Œäº†') {
                completedAt = new Date().toISOString();
            } else if (newStatus !== 'å®Œäº†') {
                completedAt = null;
            }
            
            tasks[taskIndex] = {
                ...tasks[taskIndex],
                subject: document.getElementById('edit-task-subject').value,
                taskName: document.getElementById('edit-task-name').value,
                priority: document.getElementById('edit-task-priority').value,
                status: newStatus,
                completedAt: completedAt
            };
            
            saveTasks();
            renderTasks(true);
            editTaskModal.close();
            currentEditingTaskId = null;
        }
        function handleDelete3Confirm() {
            if (currentEditingTaskId === null) return;
            if (confirm("æœ¬å½“ã«ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (1/3)")) {
                if (confirm("ã‚ã¨2å›ç¢ºèªã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ (2/3)")) {
                    if (confirm("æœ€å¾Œã®ç¢ºèªã§ã™ã€‚ã‚¿ã‚¹ã‚¯ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚ (3/3)")) {
                        tasks = tasks.filter(t => t.id !== currentEditingTaskId);
                        saveTasks();
                        renderTasks(true);
                        editTaskModal.close();
                        currentEditingTaskId = null;
                    }
                }
            }
        }
        function handleStatusChange(taskId, newStatus) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                if (newStatus === 'å®Œäº†' && task.status !== 'å®Œäº†') {
                    task.completedAt = new Date().toISOString();
                } else if (newStatus !== 'å®Œäº†') {
                    task.completedAt = null;
                }
                task.status = newStatus;
                saveTasks();
                renderTasks(false);
            }
        }
        function handlePriorityChange(taskId, newPriority) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.priority = newPriority;
                saveTasks();
                renderTasks(true);
            }
        }
        function formatDate(isoString) {
            if (!isoString) return "";
            try {
                const d = new Date(isoString);
                return d.toLocaleString('ja-JP', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
            } catch (e) { return "---"; }
        }

        // === 6. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: æç”»ãƒ­ã‚¸ãƒƒã‚¯ (V4ã¨åŒã˜) ===
        function switchViewMode(mode) {
            currentViewMode = mode;
            if (mode === 'list') {
                taskListContainer.style.display = 'block';
                kanbanBoard.style.display = 'none';
            } else {
                taskListContainer.style.display = 'flex';
                kanbanBoard.style.display = 'flex';
            }
            renderTasks(false);
        }
        function renderTasks(runSort = true) {
            const searchTerm = searchInput.value.toLowerCase();
            const hideCompleted = hideCompletedToggle.checked;
            let filteredTasks = tasks.filter(task => {
                const isMatch = task.subject.toLowerCase().includes(searchTerm) || task.taskName.toLowerCase().includes(searchTerm);
                const isHidden = hideCompleted && task.status === 'å®Œäº†';
                return isMatch && !isHidden;
            });
            if (runSort) {
                filteredTasks.sort((a, b) => (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99));
            }
            if (currentViewMode === 'list') {
                renderListView(filteredTasks);
            } else {
                renderBoardView(filteredTasks);
            }
            updateSummary();
        }
        function renderListView(tasksToRender) {
            taskListContainer.innerHTML = '';
            tasksToRender.forEach(task => {
                const taskElement = document.importNode(taskTemplateList.content, true);
                const itemDiv = taskElement.querySelector('.task-item');
                itemDiv.dataset.status = task.status;
                taskElement.querySelector('.task-subject').textContent = task.subject;
                taskElement.querySelector('.task-name').textContent = task.taskName;
                const completionDateEl = taskElement.querySelector('.task-completion-date');
                completionDateEl.textContent = task.completedAt ? `å®Œäº†: ${formatDate(task.completedAt)}` : "";
                const prioritySelect = taskElement.querySelector('.task-priority-select');
                prioritySelect.value = task.priority;
                prioritySelect.dataset.priority = task.priority;
                const statusSelect = taskElement.querySelector('.task-status-select');
                statusSelect.value = task.status;
                prioritySelect.addEventListener('change', () => handlePriorityChange(task.id, prioritySelect.value));
                statusSelect.addEventListener('change', () => handleStatusChange(task.id, statusSelect.value));
                taskElement.querySelector('.edit-task-btn').addEventListener('click', () => openEditModal(task));
                taskListContainer.appendChild(taskElement);
            });
        }
        function renderBoardView(tasksToRender) {
            Object.values(kanbanCols).forEach(col => col.innerHTML = '');
            tasksToRender.forEach(task => {
                const taskCard = document.importNode(taskTemplateCard.content, true);
                const cardDiv = taskCard.querySelector('.kanban-card');
                cardDiv.dataset.priority = task.priority;
                taskCard.querySelector('.task-subject').textContent = task.subject;
                taskCard.querySelector('.task-name').textContent = task.taskName;
                const completionDateEl = taskCard.querySelector('.task-completion-date');
                completionDateEl.textContent = task.completedAt ? `å®Œäº†: ${formatDate(task.completedAt)}` : "";
                const prioritySelect = taskCard.querySelector('.task-priority-select');
                prioritySelect.value = task.priority;
                prioritySelect.dataset.priority = task.priority;
                const statusSelect = taskCard.querySelector('.task-status-select');
                statusSelect.value = task.status;
                prioritySelect.addEventListener('change', () => handlePriorityChange(task.id, prioritySelect.value));
                statusSelect.addEventListener('change', () => handleStatusChange(task.id, statusSelect.value));
                taskCard.querySelector('.edit-task-btn').addEventListener('click', () => openEditModal(task));
                if (kanbanCols[task.status]) {
                    kanbanCols[task.status].appendChild(taskCard);
                }
            });
        }
        function updateSummary() {
            const completedCount = tasks.filter(t => t.status === 'å®Œäº†').length;
            const totalCount = tasks.length;
            progressSummary.textContent = `é€²æ—: ${completedCount} / ${totalCount} å®Œäº†`;
            const percentage = (totalCount > 0) ? (completedCount / totalCount) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
        }
        
        // === 7. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ãƒ‡ãƒ¼ã‚¿ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (V4ã¨åŒã˜) ===
        function loadAllDataFromStorage() {
            let allData = {};
            MONTHS.forEach(month => {
                const storageKey = STORAGE_KEY_PREFIX + month;
                const savedData = localStorage.getItem(storageKey);
                if (savedData) {
                    allData[month] = JSON.parse(savedData);
                } else {
                    allData[month] = allDefaultTasks[month] ? allDefaultTasks[month] : [];
                }
            });
            return allData;
        }
        function exportAllData() {
            if (!confirm('ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…¨æœˆã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const allData = loadAllDataFromStorage();
            const dataStr = JSON.stringify(allData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportLink = document.createElement('a');
            exportLink.setAttribute('href', dataUri);
            exportLink.setAttribute('download', 'report_data.json');
            exportLink.click();
        }
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!confirm('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ç¾åœ¨ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…¨é€²æ—ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                        importFileInput.value = ''; return;
                    }
                    let importedMonths = 0;
                    MONTHS.forEach(month => {
                        if (importedData[month]) {
                            const migratedData = importedData[month].map(task => ({ ...task, completedAt: task.completedAt || null }));
                            localStorage.setItem(STORAGE_KEY_PREFIX + month, JSON.stringify(migratedData));
                            importedMonths++;
                        }
                    });
                    alert(`${importedMonths}ãƒ¶æœˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚`);
                    location.reload();
                } catch (err) { alert('ã‚¨ãƒ©ãƒ¼: JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + err.message); }
                importFileInput.value = '';
            };
            reader.readAsText(file);
        }
        
        // === â˜…â˜…â˜… å¤‰æ›´ç‚¹ â˜…â˜…â˜… ===
        // 8. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼: ãƒ¬ãƒãƒ¼ãƒˆå°åˆ·å‡¦ç† (CSSåˆ†é›¢ç‰ˆ)
        function handlePrintReport() {
            const searchTerm = searchInput.value.toLowerCase();
            const hideCompleted = hideCompletedToggle.checked;
            let tasksToPrint = tasks
                .filter(task => {
                    const isMatch = task.subject.toLowerCase().includes(searchTerm) || task.taskName.toLowerCase().includes(searchTerm);
                    const isHidden = hideCompleted && task.status === 'å®Œäº†';
                    return isMatch && !isHidden;
                })
                .sort((a, b) => (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99));

            // â˜… <head>ã‹ã‚‰å°åˆ·ç”¨CSSã‚’å–å¾—
            const printStyles = document.getElementById('print-styles').innerHTML;

            const printHtml = `
                <html>
                <head>
                    <title>${currentMonth}æœˆåˆ† ãƒ¬ãƒãƒ¼ãƒˆæå‡ºè¡¨</title>
                    <style>
                        /* â˜… å–å¾—ã—ãŸCSSã‚’ã“ã“ã«æŒ¿å…¥ */
                        ${printStyles}
                    </style>
                </head>
                <body>
                    <h1>${currentMonth}æœˆåˆ† ãƒ¬ãƒãƒ¼ãƒˆæå‡ºè¡¨</h1>
                    <div class="header-info">
                        <div>æ°å: _________________________</div>
                        <div class="deadline">æå‡ºæœŸé™: ${deadlines[currentMonth] || '--/--'}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ç§‘ç›®</th>
                                <th>ã‚¿ã‚¹ã‚¯å†…å®¹</th>
                                <th>å„ªå…ˆåº¦</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>å®Œäº†æ—¥æ™‚</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tasksToPrint.map(task => `
                                <tr>
                                    <td>${task.subject}</td>
                                    <td>${task.taskName}</td>
                                    <td>${task.priority}</td>
                                    <td>${task.status}</td>
                                    <td>${formatDate(task.completedAt)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            try {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printHtml);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            } catch (e) {
                alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚Šå°åˆ·ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // === 9. ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ (V4ã¨åŒã˜) ===
        const timer = {
            isRunning: false, intervalId: null, time: 25 * 60, mode: 'work',
            workTime: 25 * 60, breakTime: 5 * 60, audioContext: null,
            selectMode() {
                const mode = timerModeSelect.value;
                customTimerInputs.style.display = (mode === 'custom') ? 'flex' : 'none';
                switch(mode) {
                    case 'pomodoro': this.workTime = 25 * 60; this.breakTime = 5 * 60; break;
                    case 'focus': this.workTime = 45 * 60; this.breakTime = 10 * 60; break;
                    case 'short': this.workTime = 15 * 60; this.breakTime = 3 * 60; break;
                    case 'custom':
                        this.workTime = parseInt(customWorkTime.value) * 60;
                        this.breakTime = parseInt(customBreakTime.value) * 60;
                        break;
                }
                this.reset();
            },
            startPause() {
                if (this.isRunning) {
                    clearInterval(this.intervalId);
                    timerStartPauseBtn.textContent = 'å†é–‹';
                } else {
                    timerStartPauseBtn.textContent = 'ä¸€æ™‚åœæ­¢';
                    if (this.mode === 'custom' && this.time === this.workTime) {
                        this.workTime = parseInt(customWorkTime.value) * 60;
                        this.breakTime = parseInt(customBreakTime.value) * 60;
                        this.time = this.workTime;
                    }
                    this.intervalId = setInterval(() => this.update(), 1000);
                }
                this.isRunning = !this.isRunning;
            },
            update() { this.time--; if (this.time < 0) this.complete(); this.display(); },
            display() {
                const minutes = Math.floor(this.time / 60).toString().padStart(2, '0');
                const seconds = (this.time % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
                document.title = `${minutes}:${seconds} - ${this.mode === 'work' ? 'å‹‰å¼·ä¸­' : 'ä¼‘æ†©ä¸­'}`;
            },
            reset() {
                clearInterval(this.intervalId);
                this.isRunning = false;
                timerStartPauseBtn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
                this.setModeDisplay('work');
            },
            complete() {
                clearInterval(this.intervalId);
                this.isRunning = false;
                this.playBeep();
                if (this.mode === 'work') {
                    this.setModeDisplay('break');
                    alert('ãŠç–²ã‚Œæ§˜ã§ã™ï¼ ä¼‘æ†©ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
                } else {
                    this.setModeDisplay('work');
                    alert('ä¼‘æ†©çµ‚äº†ã§ã™ã€‚å‹‰å¼·ã‚’å†é–‹ã—ã¾ã—ã‚‡ã†ï¼');
                }
                timerStartPauseBtn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
            },
            setModeDisplay(mode) {
                this.mode = mode;
                if (mode === 'work') {
                    this.time = this.workTime;
                    timerModeDisplay.textContent = `å‹‰å¼· (${this.workTime / 60}åˆ†)`;
                    timerDisplay.style.color = 'var(--color-primary)';
                } else {
                    this.time = this.breakTime;
                    timerModeDisplay.textContent = `ä¼‘æ†© (${this.breakTime / 60}åˆ†)`;
                    timerDisplay.style.color = 'var(--color-success)';
                }
                this.display();
            },
            playBeep() {
                try {
                    if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = this.audioContext.createOscillator();
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, this.audioContext.currentTime);
                    oscillator.connect(this.audioContext.destination);
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.5);
                } catch(e) { console.error("ãƒ“ãƒ¼ãƒ—éŸ³ã®å†ç”Ÿã«å¤±æ•—:", e); }
            }
        };

        // === 10. ã‚°ãƒ©ãƒ•ãƒšãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯ (V4ã¨åŒã˜) ===
        function renderGraphPage() {
            const allData = loadAllDataFromStorage();
            monthlyChartContainer.innerHTML = '';
            let maxCompleted = 0;
            const monthlyStats = MONTHS.map(month => {
                const tasks = allData[month] || [];
                const completed = tasks.filter(t => t.status === 'å®Œäº†').length;
                if (completed > maxCompleted) maxCompleted = completed;
                return { month: `${month}æœˆ`, completed: completed };
            });
            if (maxCompleted === 0) maxCompleted = 5;
            monthlyStats.forEach(stat => {
                const barHeight = (stat.completed / maxCompleted) * 100;
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${barHeight}%`;
                bar.innerHTML = `<div class="value">${stat.completed}</div><div class="label">${stat.month}</div>`;
                monthlyChartContainer.appendChild(bar);
            });
            priorityPieLegend.innerHTML = '';
            let priorityCounts = { "S": 0, "A": 0, "B": 0, "C": 0, "Other": 0 };
            let totalTasks = 0;
            MONTHS.forEach(month => {
                (allData[month] || []).forEach(task => {
                    if (priorityCounts.hasOwnProperty(task.priority)) priorityCounts[task.priority]++;
                    else priorityCounts["Other"]++;
                    totalTasks++;
                });
            });
            if (totalTasks === 0) {
                priorityPie.style.background = 'var(--color-border)';
                priorityPieLegend.innerHTML = 'ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“'; return;
            }
            let gradientString = '';
            let currentPercentage = 0;
            ['S', 'A', 'B', 'C'].forEach(p => {
                const percentage = (priorityCounts[p] / totalTasks) * 100;
                const color = priorityColors[p];
                if (percentage > 0) {
                    gradientString += `, ${color} ${currentPercentage}% ${currentPercentage + percentage}%`;
                    currentPercentage += percentage;
                }
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `<div class="legend-color" style="background-color:${color};"></div> ${p} (${priorityCounts[p]}ä»¶)`;
                priorityPieLegend.appendChild(legendItem);
            });
            priorityPie.style.background = `conic-gradient(${gradientString.substring(2)})`;
        }

        // === 11. ãƒ¡ãƒ¢å¸³ãƒ­ã‚¸ãƒƒã‚¯ (V4ã¨åŒã˜) ===
        function saveMemo() {
            localStorage.setItem(MEMO_KEY, memoPad.value);
        }
        function loadMemo() {
            const savedMemo = localStorage.getItem(MEMO_KEY);
            if (savedMemo) memoPad.value = savedMemo;
        }
        
    </script>
</body>
</html>
